<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shop Floor Control System - Mission Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root {
      --glow-green: #39ff14; --glow-red: #ff3131; --primary-blue: #00aaff;
      --bg-dark: #0d1117; --bg-surface: #161b22; --border-color: #30363d;
      --text-primary: #c9d1d9; --text-secondary: #8b949e;
      --font-body: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-mono: 'Roboto Mono', monospace;
      --danger-color: #ef4444; --success-color: #22c55e;
    }
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');
    
    body { font-family: var(--font-body); background: var(--bg-dark); color: var(--text-primary); margin: 0; overflow: hidden; }
    
    /* Fullscreen Mode Fixes */
    body.fullscreen-active .sidebar, body.fullscreen-active .content-header { display: none; }
    body.fullscreen-active .content-area { margin-left: 0; padding: 0; height: 100vh; width: 100vw; box-sizing: border-box; }
    body.fullscreen-active #dashboard-section { height: 100vh; display: flex; flex-direction: column; padding: 8px; }
    body.fullscreen-active .dashboard-grid { height: 100%; gap: 8px; }
    body.fullscreen-active .live-feed-widget { max-height: 35vh; min-height: 120px; }
    body.fullscreen-active .chart-widget { max-height: 30vh; }

    .main-container { display: flex; min-height: 100vh; }
    .main-container:not(.logged-in) { justify-content: center; align-items: center; padding: 20px; gap: 40px; }
    
    .login-wrapper { display: flex; justify-content: center; align-items: center; gap: 40px; width: 100%; max-width: 900px; }
    .slideshow-container { width: 50%; background: var(--bg-surface); border-radius: 8px; box-shadow: 0 4px 6px -1px #0000001a, 0 2px 4px -2px #0000001a; height: 450px; overflow: hidden; position: relative; }
    .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.8s ease-in-out; }
    .slide.active { opacity: 1; } .slide img { width: 100%; height: 100%; object-fit: cover; }
    
    .container { width: 50%; background: var(--bg-surface); border-radius: 8px; box-shadow: 0 4px 6px -1px #0000001a, 0 2px 4px -2px #0000001a; padding: 40px; text-align: center; box-sizing: border-box; border: 1px solid var(--border-color); }
    .logo { max-width: 90px; margin-bottom: 20px; }
    h2 { margin: 0 0 24px; color: var(--text-primary); font-weight: 600; }
    h4 { margin-top: 0; margin-bottom: 20px; font-size: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
    
    .sidebar { width: 250px; background: var(--bg-surface); color: var(--text-primary); height: 100vh; position: fixed; top: 0; left: 0; padding: 20px 0; display: none; z-index: 1000; border-right: 1px solid var(--border-color); }
    .sidebar.active { display: flex; flex-direction: column; }
    .sidebar-header { padding: 0 20px; margin-bottom: 30px; text-align: center; }
    .sidebar-header h3 { margin: 0; font-size: 22px; color: #fff; font-weight: 600; }
    .sidebar-options { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }
    .sidebar-options button { width: calc(100% - 32px); margin: 0 16px; padding: 12px 16px; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; color: var(--text-secondary); text-align: left; background: transparent; transition: background-color 0.2s ease, color 0.2s ease; display: flex; align-items: center; gap: 12px; font-weight: 500; }
    .sidebar-options button:hover { background: var(--border-color); color: var(--text-primary); }
    .sidebar-options button.logout-btn { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 16px; }
    .sidebar-options button svg { width: 20px; height: 20px; stroke-width: 2; }
    
    input:not([type="file"]), select { width: 100%; padding: 12px 15px; margin: 8px 0; box-sizing: border-box; border-radius: 6px; border: 1px solid var(--border-color); font-size: 15px; background: var(--bg-dark); color: var(--text-primary); }
    input:focus, select:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2); }
    select[multiple] { height: 120px; }
    .btn { display: inline-flex; justify-content: center; align-items: center; width: 100%; padding: 12px 15px; margin: 8px 0; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; transition: filter 0.2s ease; box-sizing: border-box; }
    .btn:hover { filter: brightness(1.2); }
    .btn-primary { background: var(--primary-blue); color: #fff; } .btn-success { background: var(--success-color); color: #fff; } .btn-danger { background: var(--danger-color); color: #fff; } .btn-light { background: #30363d; color: var(--text-primary); }
    
    .content-area { width: 100%; padding: 20px; display: none; box-sizing: border-box; margin-left: 250px; }
    .content-area.active { display: block; }
    .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg-surface); padding: 16px 24px; border-radius: 6px; border: 1px solid var(--border-color); }
    #welcome { margin: 0; font-size: 16px; font-weight: 600; } #stage-display { margin: 0; font-size: 14px; color: var(--text-secondary); }
    
    .main-section { display: none !important; }
    .main-section.active { display: block !important; }
    #admin-section.active { display: flex !important; flex-direction: column; gap: 20px; }

    .content-card { background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px; padding: 24px; box-sizing: border-box; }
    
    .message-box { margin: 15px 0 0 0; padding: 12px; border-radius: 6px; font-weight: 500; text-align: center; display: none; }
    .message-box.visible { display: block; }
    .message-success { background: #1c3d2f; color: #6ee7b7; border: 1px solid #22c55e4d; }
    .message-error { background: #451a25; color: #fca5a5; border: 1px solid #ef44444d; }
    
    /* Dashboard Layout */
    #dashboard-section { height: calc(100vh - 125px); display: flex; flex-direction: column; gap: 8px; padding: 8px; box-sizing: border-box; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .dashboard-header h4 { margin: 0; font-size: 20px; color: var(--primary-blue); text-shadow: 0 0 8px rgba(0, 170, 255, 0.5); }
    #fullscreen-btn { width: auto; background: none; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 6px 10px; cursor: pointer; gap: 8px; }
    .dashboard-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); grid-template-rows: auto auto minmax(120px, 1fr); gap: 8px; overflow: hidden; }
    .yield-tickers { grid-column: 1 / -1; background: #00000033; border-radius: 4px; padding: 8px; white-space: nowrap; overflow: hidden; position: relative; flex-shrink: 0; height: 40px; }
    .ticker-track { display: inline-block; padding-left: 100%; animation: ticker-scroll 40s linear infinite; }
    .ticker-item { display: inline-flex; align-items: center; gap: 12px; margin-right: 32px; font-family: var(--font-mono); }
    .ticker-item .product-name { color: var(--text-secondary); } .ticker-item .yield-rate { font-size: 16px; font-weight: 700; }
    @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .kpi-card { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; }
    .kpi-card .title { font-size: 12px; color: var(--text-secondary); margin: 0 0 6px 0; }
    .kpi-card .value { font-size: 24px; font-weight: 700; font-family: var(--font-mono); margin: 0; }
    #kpi-pass-rate .value { color: var(--glow-green); text-shadow: 0 0 8px #39ff1480; }
    #kpi-fails .value { color: var(--glow-red); text-shadow: 0 0 8px #ff313180; }
    .chart-widget { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; display: flex; flex-direction: column; min-height: 120px; max-height: 25vh; overflow: hidden; }
    .chart-widget h5 { margin: 0 0 10px 0; font-size: 13px; flex-shrink: 0; }
    #throughput-chart-container { grid-column: 1 / span 3; } #failure-chart-container { grid-column: 4 / span 1; }
    .live-feed-widget { grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; overflow-y: auto; min-height: 100px; max-height: 30vh; }
    .live-feed-widget h5 { margin: 0 0 10px 0; font-size: 13px; }
    #live-feed-list { list-style: none; padding: 0; margin: 0; font-family: var(--font-mono); font-size: 12px; }
    #live-feed-list li { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #1a2028; }
    #live-feed-list li:first-child { animation: fadeIn 0.5s ease; }
    .feed-status-pass { color: var(--glow-green); } .feed-status-fail { color: var(--glow-red); }
    @keyframes fadeIn { 0% { background: #00aaff33; } 100% { background: transparent; } }
    
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background: #0d1117; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 12px; }
    tbody tr:hover { background-color: #30363d; }
    
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: #11182799; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--bg-surface); padding: 32px; max-width: 90%; width: 650px; border-radius: 6px; border: 1px solid var(--border-color); }
    .close { float: right; font-size: 32px; cursor: pointer; color: var(--text-secondary); transition: color 0.2s ease; }
    .close:hover { color: var(--text-primary); }

    @media (max-width: 900px) { 
      .slideshow-container { display: none; } 
      .login-wrapper, .container { width: 100%; max-width: 450px; } 
    }
    @media (max-width: 768px) { 
      .main-container.logged-in { flex-direction: column; } 
      .sidebar { width: 100%; height: auto; position: static; } 
      .content-area { margin-left: 0; padding: 15px; } 
      .dashboard-grid { grid-template-columns: 1fr; grid-template-rows: auto auto minmax(100px, 1fr); } 
      #throughput-chart-container, #failure-chart-container { grid-column: auto; } 
      .live-feed-widget { max-height: 40vh; }
      .chart-widget { max-height: 35vh; }
    }
  </style>
</head>
<body>
<div class="main-container" id="main-container">
  <div class="login-wrapper" id="login-wrapper">
    <div class="slideshow-container" id="slideshow-container">
      <div class="slide active"><img src="data:image/jpeg;base64,/9j/490f//Z" alt="Industrial robot arm"></div>
      <div class="slide"><img src="data:image/jpeg;base64,/9j/4AAQg9ucy5hZGr/9k=" alt="Automated production line"></div>
    </div>
    <div class="container" id="login-container">
      <img src="data:image/png;base64,iVBORw0oo6XtMpOAJmdnlhRK8LABnuIQmCC" alt="Company Logo" class="logo">
      <h2>Mission Control Login</h2>
      <div id="login-section">
        <input type="text" id="empId" placeholder="Employee ID" aria-label="Employee ID">
        <input type="password" id="password" placeholder="Password" aria-label="Password">
        <select id="stage" aria-label="Select Stage">
          <option value="">Select Stage</option>
          <option>SERIAL NUMBER SCANNING</option>
          <option>AOI-BOT</option>
          <option>AOI-TOP</option>
          <option>REWORK</option>
          <option>MANUAL SOLDERING</option>
          <option>TESTING</option>
          <option>PACKING</option>
          <option>SMT-FQC</option>
          <option>TH-FQC</option>
        </select>
        <button id="loginBtn" class="btn btn-primary">Login</button>
        <p id="message" class="message-box"></p>
      </div>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header"><h3>SFC System</h3></div>
    <div class="sidebar-options" id="sidebar-options"></div>
  </div>

  <div class="content-area" id="content-area">
    <div class="content-header">
      <div id="welcome-info">
        <p id="welcome"></p>
        <p id="stage-display"></p>
      </div>
      <button id="logout-top-btn" class="btn" style="background: #30363d; color: white; width: auto;">Logout</button>
    </div>

    <div id="dashboard-section" class="main-section content-card">
      <div class="dashboard-header">
        <h4>Mission Control</h4>
        <button id="fullscreen-btn" class="btn" style="width: auto;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
          </svg>
          Fullscreen
        </button>
      </div>
      <div class="yield-tickers"><div class="ticker-track" id="ticker-track"></div></div>
      <div class="dashboard-grid">
        <div id="kpi-total" class="kpi-card"><p class="title">Total Scans (24h)</p><h3 class="value">--</h3></div>
        <div id="kpi-pass-rate" class="kpi-card"><p class="title">Overall Yield (24h)</p><h3 class="value">--%</h3></div>
        <div id="kpi-fails" class="kpi-card"><p class="title">Failures (24h)</p><h3 class="value">--</h3></div>
        <div id="kpi-ppm" class="kpi-card"><p class="title">Defects Per Million</p><h3 class="value">--</h3></div>
        <div id="throughput-chart-container" class="chart-widget"><h5>AOI Scan Trend</h5><div id="throughputChart"></div></div>
        <div id="failure-chart-container" class="chart-widget"><h5>Failure Analysis</h5><div id="failureChart"></div></div>
        <div class="live-feed-widget"><h5>Live Scan Feed</h5><ul id="live-feed-list"></ul></div>
      </div>
    </div>
    
    <div id="scan-section" class="main-section content-card">
      <h4>Scan PCB</h4>
      <input type="text" id="serialNumber" placeholder="Scan PCB Serial Number" aria-label="Scan PCB Serial Number">
      <div class="button-group">
        <button id="passBtn" class="btn btn-success">PASS</button>
        <button id="failBtn" class="btn btn-danger">FAIL</button>
      </div>
      <p id="scan-message" class="message-box"></p>
    </div>

    <div id="admin-section" class="main-section">
      <div id="create-employee-section" class="content-card">
        <h4>Create New Employee</h4>
        <input type="text" id="newEmpId" placeholder="Employee ID">
        <input type="password" id="newPassword" placeholder="Password">
        <select id="newStages" multiple>
          <option>SERIAL NUMBER SCANNING</option>
          <option>AOI-BOT</option>
          <option>AOI-TOP</option>
          <option>REWORK</option>
          <option>MANUAL SOLDERING</option>
          <option>TESTING</option>
          <option>PACKING</option>
          <option>SMT-FQC</option>
          <option>TH-FQC</option>
        </select>
        <button id="createEmployee" class="btn btn-primary">Create Employee</button>
      </div>
      <div id="upload-csv-section" class="content-card">
        <h4>Upload CSV for Assignment</h4>
        <input type="file" id="csvFile">
        <button id="uploadCSV" class="btn btn-light">Upload CSV</button>
        <p style="margin: 20px 0 10px; font-size: 14px; color: var(--text-secondary);">After CSV Upload, fill details below and save:</p>
        <input type="text" id="bulkPO" placeholder="PO Number">
        <input type="text" id="bulkProduct" placeholder="Product">
        <select id="bulkStages" multiple>
          <option>SERIAL NUMBER SCANNING</option>
          <option>AOI-BOT</option>
          <option>AOI-TOP</option>
          <option>SMT-FQC</option>
          <option>MANUAL SOLDERING</option>
          <option>TH-FQC</option>
          <option>TESTING</option>
          <option>PACKING</option>
          <option>REWORK</option>
        </select>
        <button id="saveBulkSerials" class="btn btn-primary">Save All</button>
      </div>
      <p id="admin-message" class="message-box"></p>
    </div>

    <div id="history-section" class="main-section content-card">
      <h4>Scan History</h4>
      <div style="display: flex; gap: 10px; margin-bottom: 16px;">
        <select id="filterType" style="width: auto; padding: 8px;">
          <option value="all">All</option>
          <option value="pass">Pass</option>
          <option value="fail">Fail</option>
        </select>
        <button id="exportHistory" class="btn btn-light" style="width: auto; padding: 8px 12px;">Export History</button>
        <input type="text" id="searchInput" placeholder="Search by Serial, PO, or Product" style="flex-grow: 1; margin: 0;">
      </div>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Serial</th><th>PO Number</th><th>Product</th><th>Last Stage</th><th>Last Status</th><th>Details</th></tr></thead>
          <tbody id="history"></tbody>
        </table>
      </div>
    </div>
    
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">√ó</span>
        <h3>Serial History</h3>
        <div id="modal-body"></div>
      </div>
    </div>
    <div id="remarks-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeRemarksModal()">√ó</span>
        <h3>Enter Failure Remarks</h3>
        <select id="remarks-input">
          <option value="">Select Reason</option>
          <option>Tombstoning</option>
          <option>Billboarding</option>
          <option>Component Missing</option>
          <option>Wrong Polarity</option>
          <option>Solder Issue</option>
          <option>Component Misalignment</option>
          <option>Other</option>
        </select>
        <input type="text" id="other-remarks" placeholder="Specify if Other" style="display:none;">
        <button id="submit-remarks" class="btn btn-danger">Submit</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const SUPABASE_URL = 'https://mjdgoqnvkmmutenruqxc.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qZGdvcW52a21tdXRlbnJ1cXhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzOTgxNzUsImV4cCI6MjA2Nzk3NDE3NX0.3xkYYJU_9-eI3WJdnTsJc_ZyJCLTNPme0g3Xwdi4JtQ';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // DOM Elements
  const mainContainer = document.getElementById('main-container');
  const loginWrapper = document.getElementById('login-wrapper');
  const slideshowContainer = document.getElementById('slideshow-container');
  const sidebar = document.getElementById('sidebar');
  const sidebarOptions = document.getElementById('sidebar-options');
  const contentArea = document.getElementById('content-area');
  const loginBtn = document.getElementById('loginBtn');
  const empIdInput = document.getElementById('empId');
  const passwordInput = document.getElementById('password');
  const stageSelect = document.getElementById('stage');
  const message = document.getElementById('message');
  const welcome = document.getElementById('welcome');
  const stageDisplay = document.getElementById('stage-display');
  const logoutTopBtn = document.getElementById('logout-top-btn');
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  const scanMessage = document.getElementById('scan-message');
  const serialInput = document.getElementById('serialNumber');
  const passBtn = document.getElementById('passBtn');
  const failBtn = document.getElementById('failBtn');
  const newEmpIdInput = document.getElementById('newEmpId');
  const newPasswordInput = document.getElementById('newPassword');
  const newStagesSelect = document.getElementById('newStages');
  const createEmployeeBtn = document.getElementById('createEmployee');
  const csvFileInput = document.getElementById('csvFile');
  const uploadCsvBtn = document.getElementById('uploadCSV');
  const bulkPOInput = document.getElementById('bulkPO');
  const bulkProductInput = document.getElementById('bulkProduct');
  const bulkStagesSelect = document.getElementById('bulkStages');
  const saveBulkSerialsBtn = document.getElementById('saveBulkSerials');
  const adminMessage = document.getElementById('admin-message');
  const searchInput = document.getElementById('searchInput');
  const historyTableBody = document.getElementById('history');
  const filterType = document.getElementById('filterType');
  const exportHistoryBtn = document.getElementById('exportHistory');
  const modal = document.getElementById('modal');
  const modalBody = document.getElementById('modal-body');
  const remarksModal = document.getElementById('remarks-modal');
  const remarksInput = document.getElementById('remarks-input');
  const otherRemarksInput = document.getElementById('other-remarks');
  const submitRemarksBtn = document.getElementById('submit-remarks');

  // State & Chart Instances
  let currentUser = {};
  let scanChannel = null;
  let throughputChart = null;
  let failureChart = null;
  let allHistory = [];
  let pendingSerial = null;
  let updateTimeout = null;

  // Helper Functions
  function showMessage(element, text, type = 'error') {
    if (!element) return;
    element.textContent = text;
    element.className = `message-box ${type === 'error' ? 'message-error' : 'message-success'}`;
    element.classList.add('visible');
    setTimeout(() => element.classList.remove('visible'), 3000);
  }

  const slides = document.querySelectorAll('.slide');
  let currentSlide = 0;
  function nextSlide() {
    if (slides.length === 0) return;
    slides[currentSlide].classList.remove('active');
    currentSlide = (currentSlide + 1) % slides.length;
    slides[currentSlide].classList.add('active');
  }
  let slideshowInterval = setInterval(nextSlide, 3500);

  fullscreenBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(err => {
        console.error(`Fullscreen error: ${err.message}`);
        showMessage(message, `Failed to enter fullscreen: ${err.message}`);
      });
      document.body.classList.add('fullscreen-active');
    } else {
      document.exitFullscreen();
      document.body.classList.remove('fullscreen-active');
    }
  });

  // Sidebar & Section Management
  function setupSidebar(isAdmin) {
    const icons = { dashboard: 'üìä', scan: 'üì†', admin: '‚öôÔ∏è', history: 'üìö', logout: 'üö™' };
    sidebarOptions.innerHTML = `
      <button onclick="showSection('dashboard-section')">${icons.dashboard} Dashboard</button>
      <button onclick="showSection('scan-section')">${icons.scan} Scan PCB</button>
      ${isAdmin ? `<button onclick="showSection('admin-section')">${icons.admin} Admin Tools</button>` : ''}
      <button onclick="showSection('history-section')">${icons.history} History</button>
      <button class="logout-btn" onclick="logout()">${icons.logout} Logout</button>`;
  }

  function showSection(id) {
    document.querySelectorAll('.main-section').forEach(section => section.classList.remove('active'));
    const section = document.getElementById(id);
    if (section) section.classList.add('active');
    if (id === 'dashboard-section') initializeDashboard();
    if (id === 'history-section') loadHistory();
    if (id === 'scan-section') serialInput.focus();
  }

  // Login/Logout Flow
  loginBtn.addEventListener('click', async () => {
    const empId = empIdInput.value.trim();
    const password = passwordInput.value.trim();
    const stage = stageSelect.value;

    if (!empId || !password || !stage) {
      showMessage(message, 'Please fill in all fields.');
      return;
    }

    let isAdmin = false;
    if (empId === 'admin' && password === 'admin') {
      isAdmin = true;
      currentUser = { empId: 'admin', stage: 'Admin' };
    } else {
      const { data, error } = await supabaseClient.from('profiles').select('*').eq('emp_id', empId).single();
      if (error || !data) {
        showMessage(message, 'Employee not found.');
        return;
      }
      if (data.password !== password) {
        showMessage(message, 'Incorrect password.');
        return;
      }
      if (!data.stages || !data.stages.includes(stage)) {
        showMessage(message, `You are not authorized for the ${stage} stage.`);
        return;
      }
      currentUser = { empId, stage };
    }

    mainContainer.classList.add('logged-in');
    loginWrapper.style.display = 'none';
    clearInterval(slideshowInterval);
    sidebar.classList.add('active');
    contentArea.classList.add('active');
    setupSidebar(isAdmin);
    welcome.textContent = `Welcome, ${empId}`;
    stageDisplay.textContent = isAdmin ? 'Admin Dashboard' : `Current Stage: ${stage}`;
    showSection('dashboard-section');
  });

  function logout() {
    if (scanChannel) {
      supabaseClient.removeChannel(scanChannel);
      scanChannel = null;
    }
    if (throughputChart) throughputChart.destroy();
    if (failureChart) failureChart.destroy();
    throughputChart = null;
    failureChart = null;
    clearTimeout(updateTimeout);
    window.location.reload();
  }
  logoutTopBtn.addEventListener('click', logout);

  // Scan Logic
  async function scan(status, remarks = '') {
    const serial = pendingSerial || serialInput.value.trim();
    if (!serial) {
      showMessage(scanMessage, 'Please enter a serial number.');
      return;
    }
    try {
      const { data: master, error: masterError } = await supabaseClient.from('serial_master').select('*').eq('serial_number', serial).single();
      if (masterError || !master) {
        showMessage(scanMessage, 'Serial not assigned or inactive.');
        return;
      }

      const { data: row } = await supabaseClient.from('scans').select('*').eq('serial_number', serial).single();
      const index = master.stages ? master.stages.indexOf(currentUser.stage) : -1;

      if (index === -1) {
        showMessage(scanMessage, 'Stage not allowed for this serial.');
        return;
      }

      const existingScan = row && row.stages ? row.stages.find(s => s.stage === currentUser.stage) : null;
      const hasFailedAtStage = existingScan && existingScan.status === 'FAIL';
      const hasReworkPass = row && row.stages ? row.stages.some(r => r.stage === 'REWORK' && r.status === 'PASS' && (!existingScan || new Date(r.timestamp) > new Date(existingScan.timestamp))) : false;

      if (existingScan && !hasFailedAtStage && currentUser.stage !== 'REWORK') {
        showMessage(scanMessage, 'Already scanned at this stage.');
        return;
      } else if (hasFailedAtStage && !hasReworkPass && currentUser.stage !== 'REWORK') {
        showMessage(scanMessage, `Serial failed at ${currentUser.stage}. Must pass REWORK first.`);
        return;
      }

      if (row && row.stages && currentUser.stage !== 'REWORK') {
        const failedStage = row.stages.find(s => s.status === 'FAIL' && s.stage !== currentUser.stage && !row.stages.some(r => r.stage === 'REWORK' && r.status === 'PASS' && new Date(r.timestamp) > new Date(s.timestamp)));
        if (failedStage) {
          showMessage(scanMessage, `Serial failed at ${failedStage.stage}. Must pass REWORK first.`);
          return;
        }
      }

      if (index > 0 && currentUser.stage !== 'REWORK') {
        const prevStage = master.stages[index - 1];
        if (!row || !row.stages || !row.stages.find(s => s.stage === prevStage && s.status === 'PASS')) {
          showMessage(scanMessage, `Previous stage ${prevStage} not passed.`);
          return;
        }
      }

      const newStage = { stage: currentUser.stage, status, emp_id: currentUser.empId, timestamp: new Date().toISOString(), remarks: status === 'FAIL' ? remarks : '' };
      let updatedStages = row ? [...row.stages] : [];
      updatedStages.push(newStage);

      if (row) {
        await supabaseClient.from('scans').update({ stages: updatedStages }).eq('serial_number', serial);
      } else {
        await supabaseClient.from('scans').insert([{ serial_number: serial, stages: [newStage] }]);
      }

      showMessage(scanMessage, `Serial '${serial}' marked as ${status}!`, 'success');
      serialInput.value = '';
      serialInput.focus();
    } catch (error) {
      console.error('Scan error:', error);
      showMessage(scanMessage, `Error saving scan: ${error.message}`);
    } finally {
      pendingSerial = null;
    }
  }

  passBtn.onclick = () => scan('PASS');
  failBtn.onclick = () => {
    if (!serialInput.value.trim()) {
      showMessage(scanMessage, 'Enter serial before marking as FAIL.');
      return;
    }
    showRemarksModal(serialInput.value.trim());
  };

  function showRemarksModal(serial) {
    pendingSerial = serial;
    remarksModal.classList.add('active');
    remarksInput.value = '';
    otherRemarksInput.style.display = 'none';
    otherRemarksInput.value = '';
  }
  function closeModal() {
    modal.classList.remove('active');
  }
  function closeRemarksModal() {
    remarksModal.classList.remove('active');
    pendingSerial = null;
  }
  remarksInput.addEventListener('change', () => {
    otherRemarksInput.style.display = remarksInput.value === 'Other' ? 'block' : 'none';
  });
  submitRemarksBtn.onclick = async () => {
    let remarks = remarksInput.value;
    if (remarks === 'Other') remarks = otherRemarksInput.value.trim();
    if (!remarks) {
      showMessage(document.createElement('p'), 'Please select or enter a remark', 'error');
      return;
    }
    await scan('FAIL', remarks);
    closeRemarksModal();
  };

  createEmployeeBtn.onclick = async () => {
    const newEmpId = newEmpIdInput.value.trim();
    const newPassword = newPasswordInput.value.trim();
    const stages = Array.from(newStagesSelect.selectedOptions).map(opt => opt.value);
    if (!newEmpId || !newPassword) {
      showMessage(adminMessage, 'Fill all employee fields.');
      return;
    }
    const { error } = await supabaseClient.from('profiles').insert([{ emp_id: newEmpId, password: newPassword, stages }]);
    if (error) showMessage(adminMessage, `Error: ${error.message}`);
    else showMessage(adminMessage, 'Employee created!', 'success');
  };

  let bulkSerials = [];
  uploadCsvBtn.onclick = async () => {
    const file = csvFileInput.files[0];
    if (!file) {
      showMessage(adminMessage, 'Please select a CSV file.');
      return;
    }
    const text = await file.text();
    bulkSerials = text.split('\n').slice(1).map(row => row.trim()).filter(r => r);
    showMessage(adminMessage, `Uploaded ${bulkSerials.length} serials. Fill details and save.`, 'success');
  };
  saveBulkSerialsBtn.onclick = async () => {
    const po = bulkPOInput.value.trim();
    const product = bulkProductInput.value.trim();
    const stages = Array.from(bulkStagesSelect.selectedOptions).map(o => o.value);
    if (!po || !product || stages.length === 0 || bulkSerials.length === 0) {
      showMessage(adminMessage, 'Fill all fields first.');
      return;
    }
    const inserts = bulkSerials.map(serial => ({ serial_number: serial, po_number: po, product: product, stages: stages }));
    const { error } = await supabaseClient.from('serial_master').insert(inserts);
    if (error) showMessage(adminMessage, `Error: ${error.message}`);
    else showMessage(adminMessage, 'All serials saved!', 'success');
  };

  async function loadHistory() {
    const { data: scans, error: scansError } = await supabaseClient.from('scans').select('*').limit(100);
    const { data: masters, error: mastersError } = await supabaseClient.from('serial_master').select('*');
    if (scansError || mastersError) {
      console.error('Error fetching history:', scansError || mastersError);
      return;
    }
    allHistory = (scans || []).map(scanRow => {
      const master = (masters || []).find(m => m.serial_number === scanRow.serial_number) || {};
      const last = scanRow.stages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0] || {};
      return { serial: scanRow.serial_number, po: master.po_number, product: master.product, lastStage: last.stage, lastStatus: last.status, stages: scanRow.stages };
    });
    renderHistory(allHistory);
  }
  function renderHistory(data) {
    const filter = filterType.value;
    const searchTerm = searchInput.value.toUpperCase();
    const filteredData = data.filter(row => 
      (filter === 'all' || row.lastStatus === filter.toUpperCase()) &&
      ((row.serial || '').toUpperCase().includes(searchTerm) || 
       (row.po || '').toUpperCase().includes(searchTerm) || 
       (row.product || '').toUpperCase().includes(searchTerm))
    );
    historyTableBody.innerHTML = (filteredData || []).map(row => `
      <tr>
        <td>${row.serial}</td>
        <td>${row.po || ''}</td>
        <td>${row.product || ''}</td>
        <td>${row.lastStage || ''}</td>
        <td style="font-weight: 600; color:${row.lastStatus === 'PASS' ? 'var(--success-color)' : 'var(--danger-color)'}">${row.lastStatus || ''}</td>
        <td><button onclick="viewDetails('${row.serial}')" class="btn btn-light" style="width:auto;padding:8px 12px;">View</button></td>
      </tr>`).join('');
  }
  function viewDetails(serial) {
    const row = allHistory.find(r => r.serial === serial);
    if (!row) {
      modalBody.innerHTML = 'Serial not found in loaded history.';
      modal.classList.add('active');
      return;
    }
    const sortedStages = row.stages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    modalBody.innerHTML = `
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Stage</th><th>Status</th><th>Emp ID</th><th>Timestamp</th><th>Remarks</th></tr></thead>
          <tbody>
            ${sortedStages.map(s => `
              <tr>
                <td>${s.stage || ''}</td>
                <td style="font-weight: 600; color:${s.status === 'PASS' ? 'var(--success-color)' : 'var(--danger-color)'}">${s.status || ''}</td>
                <td>${s.emp_id || ''}</td>
                <td>${s.timestamp ? new Date(s.timestamp).toLocaleString() : ''}</td>
                <td>${s.remarks || ''}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
    modal.classList.add('active');
  }
  searchInput.addEventListener('input', () => renderHistory(allHistory));
  filterType.addEventListener('change', () => renderHistory(allHistory));
  exportHistoryBtn.addEventListener('click', () => {
    const csv = [
      'Serial,PO Number,Product,Last Stage,Last Status',
      ...allHistory.map(row => `${row.serial},${row.po || ''},${row.product || ''},${row.lastStage || ''},${row.lastStatus || ''}`).join('\n')
    ].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'scan_history.csv';
    a.click();
    window.URL.revokeObjectURL(url);
  });

  // Dashboard Initialization & Realtime
  function initializeDashboard() {
    if (!throughputChart) {
      const throughputOptions = {
        chart: { type: 'candlestick', height: '100%', foreColor: '#c9d1d9', toolbar: { show: false } },
        series: [{ data: [] }],
        xaxis: { type: 'datetime', labels: { style: { colors: '#8b949e' } } },
        yaxis: { labels: { style: { colors: '#8b949e' } }, tooltip: { enabled: true } },
        plotOptions: {
          candlestick: {
            colors: { upward: 'var(--glow-green)', downward: 'var(--glow-red)' },
            wick: { useFillColor: true }
          }
        },
        grid: { borderColor: '#30363d' },
        tooltip: { 
          theme: 'dark',
          custom: function({ series, seriesIndex, dataPointIndex, w }) {
            const o = series[seriesIndex][dataPointIndex];
            return `<div class="custom-tooltip">
              <span>Time: ${new Date(w.globals.seriesX[seriesIndex][dataPointIndex]).toLocaleTimeString()}</span><br/>
              <span>Open: ${o[1]}</span><br/>
              <span>High: ${o[2]}</span><br/>
              <span>Low: ${o[3]}</span><br/>
              <span>Close: ${o[4]}</span>
            </div>`;
          }
        },
        annotations: {
          yaxis: [{
            y: 100,
            borderColor: '#00E396',
            label: {
              borderColor: '#00E396',
              style: { color: '#fff', background: '#00E396' },
              text: 'Baseline'
            }
          }]
        }
      };
      throughputChart = new ApexCharts(document.querySelector("#throughputChart"), throughputOptions);
      throughputChart.render();
    }
    if (!failureChart) {
      const failureOptions = {
        chart: { type: 'donut', height: '100%', foreColor: '#c9d1d9' },
        series: [],
        labels: [],
        colors: ['#ff3131', '#ff6b6b', '#ff8e8e', '#ffb3b3', '#ffd1d1'],
        plotOptions: { pie: { donut: { labels: { show: true, total: { show: true, label: 'Total Fails', color: '#c9d1d9' } } } } },
        legend: { show: false },
        tooltip: { theme: 'dark' }
      };
      failureChart = new ApexCharts(document.querySelector("#failureChart"), failureOptions);
      failureChart.render();
    }
    updateDashboardData();
    setupRealtimeChannel();
    setInterval(updateDashboardData, 10000); // Fallback polling
  }

  function setupRealtimeChannel() {
    if (scanChannel) {
      supabaseClient.removeChannel(scanChannel);
      scanChannel = null;
    }
    scanChannel = supabaseClient
      .channel('sfc-dashboard-channel')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'scans' }, payload => {
        console.log('Realtime change detected:', payload);
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(updateDashboardData, 500);
      })
      .subscribe((status, err) => {
        if (status === 'SUBSCRIBED') {
          console.log('Realtime channel subscribed successfully');
        } else if (err) {
          console.error('Realtime channel subscription failed:', err);
          showMessage(document.createElement('p'), 'Realtime updates failed, using fallback polling', 'error');
        }
      });
  }

  async function updateDashboardData() {
    try {
      const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
      const [scansRes, masterRes] = await Promise.all([
        supabaseClient.from('scans').select('serial_number, stages'),
        supabaseClient.from('serial_master').select('serial_number, product')
      ]);
      if (scansRes.error || masterRes.error) {
        console.error("Error fetching data:", scansRes.error || masterRes.error);
        showMessage(document.createElement('p'), 'Error fetching dashboard data', 'error');
        return;
      }

      const serialToProductMap = new Map(masterRes.data.map(item => [item.serial_number, item.product]));
      let totalScans24h = 0, failCount24h = 0;
      const productStats = {}, failureReasons = {}, liveFeedItems = [];
      const aoiStages = [];

      // Collect AOI stages and other metrics
      for (const scan of scansRes.data) {
        if (!scan.stages || scan.stages.length === 0) continue;
        const sortedStages = scan.stages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        sortedStages.forEach(stage => {
          if (stage.timestamp > twentyFourHoursAgo && ['AOI-BOT', 'AOI-TOP'].includes(stage.stage)) {
            aoiStages.push({ timestamp: new Date(stage.timestamp).getTime(), status: stage.status });
          }
        });
        const lastStage = sortedStages[0];
        if (lastStage.timestamp > twentyFourHoursAgo) {
          totalScans24h++;
          if (lastStage.status === 'FAIL') {
            failCount24h++;
            if (lastStage.remarks) failureReasons[lastStage.remarks] = (failureReasons[lastStage.remarks] || 0) + 1;
          }
        }
        const product = serialToProductMap.get(scan.serial_number) || 'Unknown';
        if (!productStats[product]) productStats[product] = { pass: 0, fail: 0 };
        if (lastStage.status === 'PASS') productStats[product].pass++;
        else productStats[product].fail++;
        liveFeedItems.push({ ...lastStage, serial: scan.serial_number, product });
      }

      // Update KPIs
      const passCount24h = totalScans24h - failCount24h;
      const yield24h = totalScans24h > 0 ? ((passCount24h / totalScans24h) * 100).toFixed(1) : "0.0";
      const ppm = totalScans24h > 0 ? Math.round((failCount24h / totalScans24h) * 1000000) : 0;
      document.querySelector('#kpi-total .value').textContent = totalScans24h;
      document.querySelector('#kpi-pass-rate .value').textContent = `${yield24h}%`;
      document.querySelector('#kpi-fails .value').textContent = failCount24h;
      document.querySelector('#kpi-ppm .value').textContent = ppm;

      // Update ticker
      const tickerTrack = document.getElementById('ticker-track');
      tickerTrack.innerHTML = Object.entries(productStats).map(([product, stats]) => {
        const total = stats.pass + stats.fail;
        const yieldRate = total > 0 ? ((stats.pass / total) * 100).toFixed(1) : "N/A";
        const color = yieldRate >= 95 ? 'var(--glow-green)' : 'var(--glow-red)';
        return `<div class="ticker-item"><span class="product-name">${product}:</span><span class="yield-rate" style="color: ${color};">${yieldRate}%</span></div>`;
      }).join('');
      if (tickerTrack.innerHTML) tickerTrack.innerHTML += tickerTrack.innerHTML;

      // Generate candlestick data with stock market style
      aoiStages.sort((a, b) => a.timestamp - b.timestamp);
      const intervalMs = 60000; // 1 minute
      const candleData = [];
      let currentPrice = 100;
      let lastTime = null;

      for (let i = 0; i < aoiStages.length; i++) {
        const stage = aoiStages[i];
        const currentInterval = Math.floor(stage.timestamp / intervalMs) * intervalMs;

        // Fill gaps with flat candles
        if (lastTime !== null && currentInterval > lastTime + intervalMs) {
          let gapTime = lastTime + intervalMs;
          while (gapTime < currentInterval) {
            candleData.push({
              x: gapTime,
              y: [currentPrice, currentPrice, currentPrice - 0.5, currentPrice + 0.5] // Small random fluctuation
            });
            gapTime += intervalMs;
          }
        }

        const change = stage.status === 'PASS' ? Math.random() * 2 + 1 : -Math.random() * 2 - 1; // Random change for realism
        let openPrice, closePrice, high, low;
        if (lastTime === null || currentInterval > lastTime) {
          openPrice = currentPrice;
          closePrice = openPrice + change;
          high = openPrice + Math.random() * 1.5; // Random high
          low = Math.min(openPrice, closePrice) - Math.random() * 1.5; // Random low
          candleData.push({
            x: currentInterval,
            y: [openPrice, high, low, closePrice]
          });
          lastTime = currentInterval;
        } else {
          const lastCandle = candleData[candleData.length - 1];
          openPrice = lastCandle.y[0];
          closePrice = lastCandle.y[3] + change;
          high = Math.max(lastCandle.y[1], closePrice + Math.random() * 1.5);
          low = Math.min(lastCandle.y[2], closePrice - Math.random() * 1.5);
          lastCandle.y = [openPrice, high, low, closePrice];
        }
        currentPrice = closePrice;
      }

      // Update candlestick chart with stock market style
      if (throughputChart) {
        try {
          throughputChart.updateSeries([{ data: candleData }]);
          if (candleData.length > 0) {
            const lastX = candleData[candleData.length - 1].x;
            throughputChart.zoomX(lastX - 3600000, lastX + 60000); // Last hour + buffer
          }
        } catch (e) {
          console.error('Error updating candlestick chart:', e);
        }
      }

      // Update failure chart
      const failureSeries = Object.values(failureReasons);
      const failureLabels = Object.keys(failureReasons);
      if (failureChart) {
        try {
          failureChart.updateOptions({ series: failureSeries, labels: failureLabels });
        } catch (e) {
          console.error('Error updating failure chart:', e);
        }
      }

      // Update live feed
      const liveFeedList = document.getElementById('live-feed-list');
      liveFeedList.innerHTML = liveFeedItems
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 10)
        .map(item => `<li><span>${new Date(item.timestamp).toLocaleTimeString()} - ${item.serial} (${item.product || 'N/A'})</span><span class="feed-status-${item.status.toLowerCase()}">${item.stage} -> ${item.status}</span></li>`)
        .join('');
      liveFeedList.scrollTop = 0;
    } catch (error) {
      console.error('Error updating dashboard:', error);
      showMessage(document.createElement('p'), 'Error updating dashboard data', 'error');
    }
  }
</script>
</body>
</html>
